---
title: "vse"
output: pdf_document
date: "2024-12-30"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(data.table)
library(tidyr)
```

```{r}
YEARS <- 20
n <- 20000
perc_low <- 0.5
perc_high <- 0.5

n_low <- n*perc_low
n_high <- n*perc_high

risk_low_nought_low <- 0.025 ### ugibanje
risk_low_nought_high <- 0.0025 ## deljeno z 10 za en viÅ¡ji prehod
risk_low_nought_ca <- 0.00025 ##
risk_low_nought_same <- 1 - risk_low_nought_low - risk_low_nought_high - risk_low_nought_ca
risk_low_low_high <- 0.05 #
risk_low_low_ca <- 0.005 ##
risk_low_low_same <- 1 - risk_low_low_high - risk_low_low_ca
risk_low_high_ca <- 0.02 # kvazi literatura, polovica high risk
risk_low_high_low <- 0.6 #
risk_low_high_same <- 1 - risk_low_high_ca - risk_low_high_low

risk_high_nought_low <- 0.05 ###
risk_high_nought_high <- 0.005 ###
risk_high_nought_ca <- 0.000002 ###
risk_high_nought_same <- 1 - risk_high_nought_low - risk_high_nought_high - risk_high_nought_ca
risk_high_low_high <- 0.1 #
risk_high_low_ca <- 0.01 ##
risk_high_low_same <- 1 - risk_high_low_high - risk_high_low_ca
risk_high_high_ca <- 0.035 # literatura
risk_high_high_low <- 0.3 # literatura
risk_high_high_same <- 1 - risk_high_high_ca - risk_high_high_low

risk_ca_death <- 0.05
risk_ca_curative <- 0.8
risk_ca_continue <- 1 - risk_ca_death - risk_ca_curative
risk_ca_alive <- 1-risk_ca_death

risk_IT_ca_death <- 0.01

risk_death <- 0.007 #
risk_birth <- 0.007#

surv_years <- 3
treat_years <- 5

```

# populacija

```{r}
create_population <- function(status){ # samo iscemo steady state populacijo brez screeninga in zdravljenja
  status_copy <- status
  
  for (i in 1:dim(status)[1]){
    
    random_death <- runif(1)
    if (random_death < risk_death){
      status_copy$stage[i] <- "dead_other"
      status_copy$treatment_status[i] <- "dead"

    } else { #zaklepaj random death
        if (status$risk[i]=="low"){
          if (status$stage[i]=="nought"){
            status_copy$stage[i] <- sample(c("low", "high", "ca", "nought"), 1, prob=c(risk_low_nought_low, risk_low_nought_high, risk_low_nought_ca, risk_low_nought_same))
          } else if (status$stage[i]=="low"){
              status_copy$stage[i] <- sample(c("high", "ca", "low"), 1, prob=c(risk_low_low_high, risk_low_low_ca, risk_low_low_same))
          } else if (status$stage[i]=="high"){
              status_copy$stage[i] <- sample(c("ca", "low", "high"), 1, prob=c(risk_low_high_ca, risk_low_high_low, risk_low_high_same))
          } else if (status$stage[i]=="ca"){
              status_copy$stage[i] <- sample(c("ca", "dead_AC"), 1, prob=c(risk_ca_death, risk_ca_alive))
          }
      } else if (status$risk[i]=="high"){ #zaklepaj low risk
          if (status$stage[i]=="nought"){
            status_copy$stage[i] <- sample(c("low", "high", "ca", "nought"), 1, prob=c(risk_high_nought_low, risk_high_nought_high, risk_high_nought_ca, risk_high_nought_same))
          } else if (status$stage[i]=="low"){
              status_copy$stage[i] <- sample(c("high", "ca", "low"), 1, prob=c(risk_high_low_high, risk_high_low_ca, risk_high_low_same))
          } else if (status$stage[i]=="high"){
              status_copy$stage[i] <- sample(c("ca", "low", "high"), 1, prob=c(risk_high_high_ca, risk_high_high_low, risk_high_high_same))
          } else if (status$stage[i]=="ca"){
              status_copy$stage[i] <- sample(c("ca", "dead_AC"), 1, prob=c(risk_ca_death, risk_ca_alive))
          }
      } #zaklepaj high risk
    } #zaklepaj no random death
  } #zaklepaj iterator
  
  status_copy$surv_year <- as.character((as.numeric(status_copy$surv_year) + 1)%%3)
  
  new <- rbinom(1, n, risk_birth)
  new_low <- round(perc_low * new, 0)
  new_high <- new - new_low
  
  add_lines <- as.data.frame(cbind(rep("nought", new),
                     c(rep("low", new_low), rep("high", new_high)),
                     as.character(sample(0:(surv_years-1), new, replace=TRUE)),
                     rep(NA, new),
                     rep("none", new)))
  names(add_lines) <- c("stage", "risk", "surv_year", "treatment_year", "treatment_status")
  
  
  status_copy <- rbind(status_copy, add_lines)
  status <- status_copy
  
  return(status)
  
} #zaklepaj funkcije


count_function <- function(status){
  table <- setDT(status)

  test <- setkey(table, stage, risk, surv_year, treatment_year, treatment_status)[, .N, 
               by="stage,risk,surv_year,treatment_year,treatment_status"][CJ(c("nought", "low", "high", "ca", "dead_AC", "dead_other"),
               c("low", "high"),
               as.character(seq(0, surv_years-1, 1)),
               c(seq(0, treat_years, 1), NA),
               c("none", "IT", "repeat_IT", "AIN", "AIN_history", "CA_followup", "CA_history", "dead")), 
               allow.cartesian=TRUE][is.na(N), N := 0L]
  
  return(test$N)
}

```
options_stage <- c("nought", "low", "high", "ca", "dead_AC", "dead_other")
options_risk <- c("low", "high")
options_surv_year <- seq(0, surv_years-1, 1)
options_treatment_year <- c(seq(0, treat_years, 1), NA)
options_treatment_status <- c("none", "IT", "AIN_history", "CA_history", "dead")


```{r}
stage <- rep("nought", n)
risk <- c(rep("low", n_low), rep("high", n_high))
surv_year <- as.character(sample(0:(surv_years-1), n, replace=TRUE))
treatment_year <- rep(NA, n)
treatment_status <- rep("none", n)

status <- as.data.frame(cbind(stage, risk, surv_year, treatment_year, treatment_status))

table <- setDT(status)
test <- setkey(table, stage, risk, surv_year, treatment_year, treatment_status)[, .N, 
               by="stage,risk,surv_year,treatment_year,treatment_status"][CJ(c("nought", "low", "high", "ca", "dead_AC", "dead_other"),
               c("low", "high"),
               as.character(seq(0, surv_years-1, 1)),
               c(seq(0, treat_years, 1), NA),
               c("none", "IT", "repeat_IT", "AIN", "AIN_history", "CA_followup", "CA_history", "dead")), 
               allow.cartesian=TRUE][is.na(N), N := 0L]

empty_table <- test[, 1:5]
```


```{r}
results <- empty_table
for(i in 1:YEARS){
  status <- create_population(status)
  line <- count_function(status)
  
  results <- cbind(results, line) #rabim za risanje generiranja simulacije, za dejansko stetje pa ne

}
```

```{r}
dead_AC <- which(results$stage=="dead_AC" & results$treatment_status!="dead")
results <- results[-dead_AC,]
dead_other <- which(results$stage=="dead_other" & results$treatment_status!="dead")
results <- results[-dead_other,]

results_df <- setDF(results)

partial_names_interim <- as.character(seq(1, YEARS, 1))
partial_names <- paste("year_", partial_names_interim, sep="")
names_full <- c("stage", "risk", "surv_year", "treatment_year", "treatment_status", partial_names)
names(results_df) <- names_full



results_agg <- aggregate(. ~ stage + risk, results_df[, c(1, 2, 6:(YEARS+5))], sum)

dead_numbers <- which(results_agg$stage=="dead_AC" | results_agg$stage=="dead_other")
agg_dead <- results_agg[dead_numbers,]
agg_alive <- results_agg[-dead_numbers,]

for (i in 3:(YEARS+2)){
  agg_alive[, i] <- agg_alive[,i]/sum(agg_alive[,i] )* 100
}

for (i in 3:(YEARS+2)){
  agg_dead[, i] <- agg_dead[,i]/sum(agg_dead[,i] )* 100
}



agg_long_dead <- pivot_longer(agg_dead, 
    cols = starts_with("year_"),
    names_to = "year",
    names_prefix = "year_",
    values_to = "perc"
  )

agg_long_alive <- pivot_longer(agg_alive, 
    cols = starts_with("year_"),
    names_to = "year",
    names_prefix = "year_",
    values_to = "perc"
)


```


```{r}
ggplot(data=agg_long_alive) + geom_line(aes(x=as.numeric(year), y=perc, color=stage, linetype=risk)) 
ggplot(data=agg_long_alive[which(agg_long_alive$stage!="nought"),]) + geom_line(aes(x=as.numeric(year), y=perc, color=stage, linetype=risk)) 

ggplot(data=agg_long_dead) + geom_line(aes(x=as.numeric(year), y=perc, color=stage, linetype=risk)) 
```
# zaznavanje/zdravljenje

options_stage <- c("nought", "1", "2", "3", "A", "B", "C", "D", "dead_AC", "dead_other")
options_risk <- c("low", "high")
options_surv_year <- seq(0, surv_years-1, 1)
options_treatment_year <- c(seq(0, treat_years, 1), NA)
options_treatment_status <- c("none", "IT", "repeat_IT", "AIN_history", "CA_followup", "CA_history", "dead")


```{r}
ongoing_population <- function(status){ # spreminjanje populacije, ki je lahko tudi zaznana in zdravljena
  status_copy <- status
  
  for (i in 1:dim(status)[1]){
    random_death <- runif(1)
    if (random_death < risk_death){
      status_copy$stage[i] <- "dead_other"
      status_copy$treatment_status[i] <- "dead"

    } else { #zaklepaj random death
        random <- runif(1)

        if (status$treatment_status[i]=="IT" | status$treatment_status[i]=="repeat_IT"){ #vse AIN imajo treatment_status AIN_history, in se tu obravnavajo kot "low" in "high" risk
          if (status$stage[i]=="ca"){
            if (random < 0.8){# ti so ozdraveli in zacnejo steti leta za followup
              status_copy$stage[i] <- "nought"
              status_copy$treatment_status[i] <- "CA_followup"
              status_copy$treatment_year[i] <- 1
            }
          } else if (random < 0.8 + risk_IT_ca_death){
              status_copy$stage[i] <- "dead_AC"
              status_copy$treatment_status[i] <- "dead"
          }
        } else { #zaklepaj in treatment
            if (status$treatment_status[i]=="AIN"){
              status$treatment_status[i] <- "AIN_history" # popravimo status, ker je lani imel AIN, zdaj je ze v zgodovini
              status$stage[i] <- "nought" # popravimo stage, ker je bil AIN lani odstranjen
            }
            if (status$risk[i]=="low"){
              if (status$stage[i]=="nought"){
                status_copy$stage[i] <- sample(c("low", "high", "ca", "nought"), 1, prob=c(risk_low_nought_low, risk_low_nought_high, risk_low_nought_ca, risk_low_nought_same))
              } else if (status$stage[i]=="low"){
                  status_copy$stage[i] <- sample(c("high", "ca", "low"), 1, prob=c(risk_low_low_high, risk_low_low_ca, risk_low_low_same))
              } else if (status$stage[i]=="high"){
                  status_copy$stage[i] <- sample(c("ca", "low", "high"), 1, prob=c(risk_low_high_ca, risk_low_high_low, risk_low_high_same))
              } else if (status$stage[i]=="ca"){
                  status_copy$stage[i] <- sample(c("ca", "dead_AC"), 1, prob=c(risk_ca_death, risk_ca_alive))
              }
          } else if (status$risk[i]=="high"){ #zaklepaj low risk
              if (status$stage[i]=="nought"){
                status_copy$stage[i] <- sample(c("low", "high", "ca", "nought"), 1, prob=c(risk_high_nought_low, risk_high_nought_high, risk_high_nought_ca, risk_high_nought_same))
              } else if (status$stage[i]=="low"){
                  status_copy$stage[i] <- sample(c("high", "ca", "low"), 1, prob=c(risk_high_low_high, risk_high_low_ca, risk_high_low_same))
              } else if (status$stage[i]=="high"){
                  status_copy$stage[i] <- sample(c("ca", "low", "high"), 1, prob=c(risk_high_high_ca, risk_high_high_low, risk_high_high_same))
              } else if (status$stage[i]=="ca"){
                  status_copy$stage[i] <- sample(c("ca", "dead_AC"), 1, prob=c(risk_ca_death, risk_ca_alive))
              }
          } #zaklepaj high risk
        } # zaklepaj not in treatment
    } #zaklepaj no random death
  } #zaklepaj iterator
  
  status_copy$surv_year <- (as.numeric(status_copy$surv_year) + 1)%%3
  status_copy$treatment_year <- (as.numeric(status_copy$treatment_year) + 1)%%5
  
  for (i in 1:dim(status)[1]){
    if (is.na(status_copy$treatment_year[i])==FALSE){
      if (status_copy$treatment_year[i]==0){
        status_copy$treatment_year[i] <- NA
        status_copy$treatment_status[i] <- "CA_history"
        status_copy$surv_year[i] <- 0
      }
    }
    
  }
  

  
  new <- rbinom(1, n, risk_birth)
  new_low <- round(perc_low * new, 0)
  new_high <- new - new_low
  
  add_lines <- as.data.frame(cbind(rep("nought", new),
                     c(rep("low", new_low), rep("high", new_high)),
                     sample(0:(surv_years-1), new, replace=TRUE),
                     rep(NA, new),
                     rep("none", new)))
  names(add_lines) <- c("stage", "risk", "surv_year", "treatment_year", "treatment_status")
  
  
  status_copy <- rbind(status_copy, add_lines)
  status_copy$surv_year <- as.numeric(status_copy$surv_year)
  status_copy$treatment_year <- as.numeric(status_copy$treatment_year)
  status <- status_copy
  
  return(status)
  
} #zaklepaj funkcije

diagnosis_function <- function(status){
  
  for (i in 1:dim(status)[1]){
    if (status$treatment_status[i]!="dead"){
      random <- runif(1)
      if (status$treatment_status[i]=="CA_followup"){#gledamo vsako leto, najdemo vse; "IT" tudi gledamo vsako leto, ampak najden AIN ne spremeni nicesar, ker ga samo odstranimo in itak ni generiran in gre zdravljenje naprej, ca pa ne bomo nasli, ker ga gledamo vsako leto
        if (status$stage[i] =="ca"){
          status$treatment_year[i] <- NA
          status$treatment_status[i] <- "repeat_IT"
        }
      } else if (status$treatment_status[i]=="none" | status$treatment_status[i]=="AIN_history" | status$treatment_status[i]=="CA_history" ) {#gledamo na screening, ostale najdemo samo nakljucno; zaklepaj in treatment
        if (status$surv_year[i]==0){ #te screenamo
          if (status$stage[i]=="low"){
            if (random < find_low_screen){
              if(status$treatment_status[i]=="none")
              status$treatment_status[i] <- "AIN"
            }
          } else if (status$stage[i]=="high"){
            if (random < find_high_screen){
              if(status$treatment_status[i]=="none")
              status$treatment_status[i] <- "AIN"
            }
          } else if (status$stage[i]=="ca"){
            if (random < find_ca_screen){
              status$treatment_status[i] <- "IT"
              status$treatment_year[i] <- 0
              status$surv_year[i] <- NA
            }
          } 
        } else { #te nademo samo nakljucno; zaklepaj screenani
            if (status$stage[i]=="ca"){
              if (random < find_ca_null){
                status$treatment_status[i] <- "IT"
                status$treatment_year[i] <- 0
                status$surv_year[i] <- NA
              }
            } 
        } #zaklepaj nakljucni
      }#zaklepaj not in treatment
    } # zaklepaj ali je sploh ziv
    
  }# zaklepaj iteratorja
  
  return(status)
}# zaklepaj funkcije



count_function <- function(status){
  table <- setDT(status)

  test <- setkey(table, stage, risk, surv_year, treatment_year, treatment_status)[, .N, 
               by="stage,risk,surv_year,treatment_year,treatment_status"][CJ(c("nought", "low", "high", "ca", "dead_AC", "dead_other"),
               c("low", "high"),
               c(seq(0, surv_years-1, 1), NA),
               c(seq(0, treat_years, 1), NA),
               c("none", "IT", "repeat_IT", "AIN", "AIN_history", "CA_followup", "CA_history", "dead")), 
               allow.cartesian=TRUE][is.na(N), N := 0L]
  
  return(test$N)
}

```



```{r}
find_low_null <- 0
find_high_null <- 0# ce to dvignes, moras spremeniti kodo?
find_ca_null <- 0.1

find_low_screen <- 0.6 # od tu naprej rabis tri sete, za boljsi in slabsi screen in sploh brez screena
find_high_screen <- 0.8
find_ca_screen <- 1
```

```{r}
#ZAZENES ENKRAT; POTEM SE NE DOTIKAS, DA OHRANIS status_start!!!!!
status_start <- status[which(status$treatment_status!="dead"),] # ciscenje predhodnih mrtvih iz generirane populacije
```

```{r}
status <- status_start
status$treatment_year <- as.numeric(status$treatment_year)
status$surv_year <- as.numeric(status$surv_year)

```

```{r}
table <- setDT(status)
test <- setkey(table, stage, risk, surv_year, treatment_year, treatment_status)[, .N, 
               by="stage,risk,surv_year,treatment_year,treatment_status"][CJ(c("nought", "low", "high", "ca", "dead_AC", "dead_other"),
               c("low", "high"),
               c(seq(0, surv_years-1, 1), NA),
               c(seq(0, treat_years, 1), NA),
               c("none", "IT", "repeat_IT", "AIN", "AIN_history", "CA_followup", "CA_history", "dead")), 
               allow.cartesian=TRUE][is.na(N), N := 0L]

empty_table_ongoing <- test[, 1:5]
```


```{r}
results <- empty_table_ongoing
for(i in 1:YEARS){
  status <- ongoing_population(status)
  status <- diagnosis_function(status)
  line <- count_function(status)
  
  results <- cbind(results, line)

}
```

```{r}
find_low_screen <- 0.9 # od tu naprej rabis tri sete, za boljsi in slabsi screen in sploh brez screena
find_high_screen <- 1
find_ca_screen <- 1
```

```{r}
for(i in 1:YEARS){
  status <- ongoing_population(status)
  status <- diagnosis_function(status)
  line <- count_function(status)
  
  results <- cbind(results, line)

}
```

```{r}
dead_AC <- which(results$stage=="dead_AC" & results$treatment_status!="dead")
results <- results[-dead_AC,]
dead_other <- which(results$stage=="dead_other" & results$treatment_status!="dead")
results <- results[-dead_other,]

results_df <- setDF(results)

partial_names_interim <- as.character(seq(1, YEARS, 1))
partial_names <- paste("year_", partial_names_interim, sep="")
names_full <- c("stage", "risk", "surv_year", "treatment_year", "treatment_status", partial_names)
names(results_df) <- names_full



results_agg <- aggregate(. ~ stage + risk, results_df[, c(1, 2, 6:(YEARS+5))], sum)

dead_numbers <- which(results_agg$stage=="dead_AC" | results_agg$stage=="dead_other")
agg_dead <- results_agg[dead_numbers,]
agg_alive <- results_agg[-dead_numbers,]

agg_long_dead <- pivot_longer(agg_dead, 
    cols = starts_with("year_"),
    names_to = "year",
    names_prefix = "year_",
    values_to = "count"
  )

agg_long_alive <- pivot_longer(agg_alive, 
    cols = starts_with("year_"),
    names_to = "year",
    names_prefix = "year_",
    values_to = "count"
)


agg_alive_perc <- agg_alive
agg_dead_perc <- agg_dead

for (i in 3:(YEARS+2)){
  agg_alive_perc[, i] <- agg_alive_perc[,i]/sum(agg_alive_perc[,i] )* 100
}

for (i in 3:(YEARS+2)){
  agg_dead_perc[, i] <- agg_dead_perc[,i]/sum(agg_dead_perc[,i] )* 100
}



agg_long_dead_perc <- pivot_longer(agg_dead_perc, 
    cols = starts_with("year_"),
    names_to = "year",
    names_prefix = "year_",
    values_to = "perc"
  )

agg_long_alive_perc <- pivot_longer(agg_alive_perc, 
    cols = starts_with("year_"),
    names_to = "year",
    names_prefix = "year_",
    values_to = "perc"
)


```

```{r}
ggplot(data=agg_long_alive) + geom_line(aes(x=as.numeric(year), y=count, color=stage, linetype=risk)) 
ggplot(data=agg_long_alive[which(agg_long_alive$stage!="nought"),]) + geom_line(aes(x=as.numeric(year), y=count, color=stage, linetype=risk)) 

ggplot(data=agg_long_dead) + geom_line(aes(x=as.numeric(year), y=count, color=stage, linetype=risk)) 
```

```{r}
ggplot(data=agg_long_alive_perc) + geom_line(aes(x=as.numeric(year), y=perc, color=stage, linetype=risk)) 
ggplot(data=agg_long_alive_perc[which(agg_long_alive_perc$stage!="nought"),]) + geom_line(aes(x=as.numeric(year), y=perc, color=stage, linetype=risk)) 

ggplot(data=agg_long_dead_perc) + geom_line(aes(x=as.numeric(year), y=perc, color=stage, linetype=risk)) 
```
